<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="apppasteleriav04.Views.Cart.CheckoutPage"
             Title="{Binding Title}">

    <ContentPage.Resources>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="BackgroundColor" Value="#6C63FF"/>
            <Setter Property="TextColor" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="12,10"/>
        </Style>

        <Style x:Key="SecondaryButton" TargetType="Button">
            <Setter Property="BackgroundColor" Value="#E0E0E0"/>
            <Setter Property="TextColor" Value="#222"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="12,10"/>
        </Style>
    </ContentPage.Resources>

    <ContentPage.Content>
        <Grid RowDefinitions="*,Auto" Padding="12">

            <!-- Contenido principal con scroll -->
            <ScrollView Grid.Row="0">
                <VerticalStackLayout Spacing="12">

                    <Label Text="Confirmar pedido" FontSize="22" FontAttributes="Bold" />

                    <!-- Lista de productos -->
                    <CollectionView ItemsSource="{Binding Items}"
                                    SelectionMode="None"
                                    MaximumHeightRequest="300">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame Padding="10" Margin="0,6" CornerRadius="10" HasShadow="True">
                                    <Grid ColumnDefinitions="80,*,Auto">
                                        <Frame CornerRadius="8"
                                               HasShadow="False"
                                               BackgroundColor="#F6F6F6"
                                               HeightRequest="72"
                                               WidthRequest="72"
                                               HorizontalOptions="Start"
                                               VerticalOptions="Center">
                                            <Image Source="{Binding ImageUrl, TargetNullValue='placeholder.png'}"
                                                   Aspect="AspectFill"/>
                                        </Frame>

                                        <VerticalStackLayout Grid.Column="1" Spacing="4" Padding="8,0">
                                            <Label Text="{Binding ProductName}" FontAttributes="Bold" LineBreakMode="TailTruncation" MaxLines="2"/>
                                            <Label Text="{Binding Quantity, StringFormat='Cantidad: {0}'}" FontSize="12" TextColor="#555"/>
                                            <Label Text="{Binding Price, StringFormat='S/ {0:N2}'}" FontSize="12" TextColor="#555"/>
                                        </VerticalStackLayout>

                                        <Label Grid.Column="2" 
                                               Text="{Binding Subtotal, StringFormat='S/ {0:N2}'}" 
                                               VerticalOptions="Center" 
                                               FontAttributes="Bold"/>
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Dirección -->
                    <Label Text="Dirección de entrega" FontAttributes="Bold" />
                    <Editor Text="{Binding Address}" 
                            AutoSize="TextChanges" 
                            Placeholder="Calle, número, referencia..." 
                            HeightRequest="80"/>

                    <!-- Switch delivery -->
                    <HorizontalStackLayout VerticalOptions="Center" Spacing="8">
                        <Label Text="Entrega a domicilio" VerticalOptions="Center"/>
                        <Switch IsToggled="{Binding IsDelivery}"/>
                    </HorizontalStackLayout>

                    <!-- Método de pago -->
                    <Label Text="Método de pago" FontAttributes="Bold" />
                    <Picker x:Name="PaymentPicker" 
                            Title="Seleccionar método"
                            SelectedIndex="{Binding PaymentMethodIndex}">
                        <Picker.Items>
                            <x:String>Efectivo al recibir
                                </x:String>
                                <x:String>Tarjeta (POS)</x:String>
                                <x:String>Tarjeta (online)
                                    </x:String>
                        </Picker.Items>
                    </Picker>

                    <!-- Resumen de totales -->
                    <Frame Padding="12" CornerRadius="8" HasShadow="True" BackgroundColor="#F8F8F8">
                        <VerticalStackLayout Spacing="8">
                            <HorizontalStackLayout>
                                <Label Text="Subtotal:" />
                                <Label HorizontalOptions="EndAndExpand" Text="{Binding Subtotal, StringFormat='S/ {0:N2}'}"/>
                            </HorizontalStackLayout>
                            <HorizontalStackLayout>
                                <Label Text="Envío:" />
                                <Label HorizontalOptions="EndAndExpand" Text="{Binding ShippingCost, StringFormat='S/ {0:N2}'}"/>
                            </HorizontalStackLayout>
                            <BoxView HeightRequest="1" BackgroundColor="#DDD"/>
                            <HorizontalStackLayout>
                                <Label Text="Total:" FontAttributes="Bold" FontSize="18"/>
                                <Label HorizontalOptions="EndAndExpand" 
                                       Text="{Binding Total, StringFormat='S/ {0:N2}'}" 
                                       FontAttributes="Bold" 
                                       FontSize="18"
                                       TextColor="#2E7D32"/>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Mensaje de error -->
                    <Frame IsVisible="{Binding HasError}" 
                           BackgroundColor="#FFEBEE" 
                           BorderColor="#C62828"
                           Padding="12"
                           CornerRadius="8">
                        <Label Text="{Binding ErrorMessage}" 
                               TextColor="#C62828" 
                               FontSize="14"/>
                    </Frame>

                    <!-- Indicador de carga -->
                    <ActivityIndicator IsVisible="{Binding IsBusy}" 
                                       IsRunning="{Binding IsBusy}" 
                                       Color="#6C63FF"
                                       HeightRequest="40" />
                </VerticalStackLayout>
            </ScrollView>

            <!-- Footer fijo con botones -->
            <Grid Grid.Row="1" 
                  Padding="12,8" 
                  ColumnDefinitions="*,*" 
                  ColumnSpacing="12"
                  BackgroundColor="#FFFFFF">

                <Button Grid.Column="0"
                        Text="Volver" 
                        Style="{StaticResource SecondaryButton}" 
                        Clicked="OnBackClicked"/>

                <Button Grid.Column="1"
                        Text="Pagar y confirmar" 
                        Style="{StaticResource PrimaryButton}" 
                        Command="{Binding PlaceOrderCommand}"/>
            </Grid>
        </Grid>
    </ContentPage.Content>
</ContentPage>