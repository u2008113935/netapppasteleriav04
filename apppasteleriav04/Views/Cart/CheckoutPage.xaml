<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="apppasteleriav04.Views.Cart.CheckoutPage"
             Title="{Binding Title}">

    <ContentPage.Resources>
        <Style x:Key="PrimaryButton" TargetType="Button">
            <Setter Property="BackgroundColor" Value="#6C63FF"/>
            <Setter Property="TextColor" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="12,10"/>
        </Style>

        <Style x:Key="SecondaryButton" TargetType="Button">
            <Setter Property="BackgroundColor" Value="#E0E0E0"/>
            <Setter Property="TextColor" Value="#222"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="12,10"/>
        </Style>
    </ContentPage.Resources>

    <ContentPage.Content>
        <Grid RowDefinitions="Auto,*,Auto" Padding="12">
            <ScrollView Grid.Row="1">
                <VerticalStackLayout Spacing="12">

                    <Label Text="Confirmar pedido" FontSize="22" FontAttributes="Bold" />

                    <Label Text="Tu carrito está vacío"
                           IsVisible="False"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           FontAttributes="Italic" />

                    <CollectionView ItemsSource="{Binding Items}"
                                    SelectionMode="None"
                                    HeightRequest="260"
                                    ItemsLayout="VerticalList">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame Padding="10" Margin="0,6" CornerRadius="10" HasShadow="True">
                                    <Grid ColumnDefinitions="80,*,Auto" RowDefinitions="Auto,Auto">
                                        <Frame CornerRadius="8"
                                               HasShadow="False"
                                               BackgroundColor="#F6F6F6"
                                               HeightRequest="72"
                                               WidthRequest="72"
                                               HorizontalOptions="Start"
                                               VerticalOptions="Center">
                                            <Image Source="{Binding ProductImageUrl, TargetNullValue='placeholder.png'}"
                                                   WidthRequest="72"
                                                   HeightRequest="72"
                                                   Aspect="AspectFill"/>
                                        </Frame>

                                        <VerticalStackLayout Grid.Column="1" Spacing="4" Padding="8,0">
                                            <Label Text="{Binding ProductName}" FontAttributes="Bold" LineBreakMode="TailTruncation" MaxLines="2"/>
                                            <Label Text="{Binding Quantity, StringFormat='Cantidad: {0}'}" FontSize="12" TextColor="#555"/>
                                            <Label Text="{Binding Price, StringFormat='Precio: {0:C2}'}" FontSize="12" TextColor="#555"/>
                                        </VerticalStackLayout>

                                        <Label Grid.Column="2" Text="{Binding Subtotal, StringFormat='{0:C2}'}" VerticalOptions="Center" FontAttributes="Bold" HorizontalOptions="End"/>
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <Label Text="Dirección de entrega" FontAttributes="Bold" />
                    <Editor Text="{Binding Address}" AutoSize="TextChanges" Placeholder="Calle, número, referencia..." HeightRequest="80"/>

                    <HorizontalStackLayout VerticalOptions="Center" Spacing="8">
                        <Label Text="Entrega a domicilio" VerticalOptions="Center"/>
                        <Switch IsToggled="{Binding IsDelivery}"/>
                    </HorizontalStackLayout>

                    <Label Text="Método de pago" FontAttributes="Bold" />
                    <Picker x:Name="PaymentPicker" 
                            Title="Seleccionar método"
                            SelectedIndex="{Binding PaymentMethodIndex}">
                        <Picker.Items>
                            <x:String>Efectivo al recibir</x:String>
                            <x:String>Tarjeta (POS)</x:String>
                            <x:String>Tarjeta (online)</x:String>
                        </Picker.Items>
                    </Picker>

                    <VerticalStackLayout IsVisible="{Binding ShowCardDetails}" Spacing="8">
                        <Label Text="Datos de tarjeta" FontAttributes="Bold"/>
                        <Entry Text="{Binding CardHolder}" Placeholder="Nombre en la tarjeta" Keyboard="Text"/>
                        <Entry Text="{Binding CardNumber}" Placeholder="Número de tarjeta" Keyboard="Numeric"/>
                        <HorizontalStackLayout Spacing="8">
                            <Entry Placeholder="MM/AA" WidthRequest="120"/>
                            <Entry Placeholder="CVV" WidthRequest="100" IsPassword="True" Keyboard="Numeric"/>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>

                    <Label Text="Instrucciones / comentarios" FontAttributes="Bold"/>
                    <Editor AutoSize="TextChanges" HeightRequest="60" Placeholder="Ej.: Sin azúcar, llamar antes de entregar..."/>

                    <Frame Padding="8" CornerRadius="8" HasShadow="True">
                        <VerticalStackLayout>
                            <HorizontalStackLayout>
                                <Label Text="Subtotal:" />
                                <Label HorizontalOptions="EndAndExpand" Text="{Binding Subtotal, StringFormat='S/ {0:N2}'}"/>
                            </HorizontalStackLayout>
                            <HorizontalStackLayout>
                                <Label Text="Envío:" />
                                <Label HorizontalOptions="EndAndExpand" Text="{Binding ShippingCost, StringFormat='S/ {0:N2}'}"/>
                            </HorizontalStackLayout>
                            <HorizontalStackLayout>
                                <Label Text="Total:" FontAttributes="Bold"/>
                                <Label HorizontalOptions="EndAndExpand" Text="{Binding Total, StringFormat='S/ {0:N2}'}" FontAttributes="Bold"/>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Error message -->
                    <Label Text="{Binding ErrorMessage}" 
                           TextColor="Red" 
                           IsVisible="{Binding HasError}"
                           FontSize="12"
                           HorizontalOptions="Center" />

                    <HorizontalStackLayout Spacing="12">
                        <Button Text="Volver" Clicked="OnBackClicked" HorizontalOptions="StartAndExpand"/>
                        <Button Text="Pagar y confirmar" 
                                BackgroundColor="#2E7D32" 
                                TextColor="White" 
                                Command="{Binding PlaceOrderCommand}"
                                HorizontalOptions="EndAndExpand"/>
                    </HorizontalStackLayout>

                    <ActivityIndicator IsVisible="{Binding IsBusy}" IsRunning="{Binding IsBusy}" HeightRequest="36" />
                </VerticalStackLayout>
            </ScrollView>

            <!-- Footer fijo -->
            <Grid Grid.Row="2" Padding="8" ColumnDefinitions="*,Auto" RowDefinitions="Auto" BackgroundColor="#FFFFFF">
                <Button Text="Volver" Style="{StaticResource SecondaryButton}" Clicked="OnBackClicked" HorizontalOptions="Start"/>
                <Button Text="Pagar y confirmar" 
                        Style="{StaticResource PrimaryButton}" 
                        Command="{Binding PlaceOrderCommand}"
                        HorizontalOptions="End"/>
            </Grid>
        </Grid>
    </ContentPage.Content>
</ContentPage>