<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:conv="clr-namespace:apppasteleriav04.Converters"
    x:Class="apppasteleriav04.Views.Orders.OrderPage"
    Title="{Binding Title}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:ImagePathToUriConverter x:Key="ImagePathToUriConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto" Padding="12">

        <!-- Header / summary -->
        <StackLayout Orientation="Horizontal" Spacing="12" VerticalOptions="Center" Grid.Row="0">
            <Label Text="Pedidos" FontSize="22" FontAttributes="Bold" VerticalOptions="Center" />
            <ActivityIndicator IsRunning="{Binding IsLoading}" IsVisible="{Binding IsLoading}" VerticalOptions="Center" />
        </StackLayout>

        <!-- Filter / simple search (optional) -->
        <StackLayout Orientation="Horizontal" Grid.Row="1" Padding="0,8,0,8">
            <Label Text="Estado:" VerticalOptions="Center" />
            <Picker x:Name="StatusPicker" Title="Todos" WidthRequest="160" HorizontalOptions="Start" />
            <Button Text="Actualizar" Command="{Binding LoadOrdersCommand}" HorizontalOptions="EndAndExpand" />
        </StackLayout>

        <!-- Orders list with Pull-to-Refresh -->
        <RefreshView x:Name="RefreshViewControl" 
                     IsRefreshing="{Binding IsLoading}" 
                     Command="{Binding LoadOrdersCommand}"
                     Grid.Row="2">
            <CollectionView ItemsSource="{Binding Orders}"
                            SelectionMode="Single"
                            EmptyView="No se encontraron pedidos."
                            SelectionChanged="OrdersCollection_SelectionChanged">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Margin="0,6" Padding="10" HasShadow="True" BorderColor="#ddd" CornerRadius="8">
                            <Grid ColumnDefinitions="60,*,Auto" RowDefinitions="Auto,Auto">
                                <Image Grid.RowSpan="2" Grid.Column="0" WidthRequest="56" HeightRequest="56" Aspect="AspectFill"
                                       Source="{Binding Items[0].ImagenPath, Converter={StaticResource ImagePathToUriConverter}}" />

                                <Label Grid.Column="1" Grid.Row="0" Text="{Binding Id}" FontAttributes="Bold" FontSize="12" LineBreakMode="TailTruncation" />
                                <Label Grid.Column="1" Grid.Row="1" Text="{Binding CreatedAt, StringFormat='Fecha: {0:yyyy-MM-dd HH:mm}'}" FontSize="12" TextColor="Gray" />

                                <StackLayout Grid.Column="2" Grid.Row="0" Grid.RowSpan="2" HorizontalOptions="End" VerticalOptions="Center" Spacing="6">
                                    <Label Text="{Binding Total, StringFormat='S/ {0:N2}'}" FontAttributes="Bold" HorizontalTextAlignment="End" />
                                    <Label Text="{Binding Status}" FontSize="12" TextColor="White" BackgroundColor="#6c757d" Padding="6,2" HorizontalTextAlignment="Center" />
                                    <Button Text="Ver / Seguir" Clicked="OnViewOrTrackClicked" CommandParameter="{Binding Id}" />
                                </StackLayout>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Footer: count and error message -->
        <StackLayout Orientation="Vertical" Grid.Row="3" Padding="0,8,0,0">
            <Label Text="{Binding Orders.Count, StringFormat='Pedidos: {0}'}" />
            <Label Text="{Binding ErrorMessage}" 
                   TextColor="Red" 
                   IsVisible="{Binding HasError}"
                   FontSize="12" />
        </StackLayout>
    </Grid>
</ContentPage>