<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="apppasteleriav04.Views.Billing.InvoicePage"
             xmlns:vm="clr-namespace:apppasteleriav04.ViewModels.Billing"
             Title="Generar Comprobante">

    <ContentPage.BindingContext>
        <vm:InvoiceViewModel />
    </ContentPage.BindingContext>

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!-- Invoice Type Selection -->
            <Label Text="Tipo de Comprobante" FontSize="18" FontAttributes="Bold" />

            <HorizontalStackLayout Spacing="10">
                <RadioButton Content="Boleta" 
                             IsChecked="{Binding InvoiceType, Converter={StaticResource StringEqualConverter}, ConverterParameter='boleta'}"
                             GroupName="InvoiceType"
                             x:Name="BoletaRadio" />
                <RadioButton Content="Factura" 
                             IsChecked="{Binding InvoiceType, Converter={StaticResource StringEqualConverter}, ConverterParameter='factura'}"
                             GroupName="InvoiceType"
                             x:Name="FacturaRadio" />
            </HorizontalStackLayout>

            <!-- Customer Information -->
            <Label Text="Datos del Cliente" FontSize="18" FontAttributes="Bold" />

            <VerticalStackLayout Spacing="10">
                <VerticalStackLayout Spacing="5">
                    <Label Text="Nombre / Razón Social" />
                    <Entry Text="{Binding CustomerName}" Placeholder="Ingrese nombre o razón social" />
                </VerticalStackLayout>

                <!-- RUC field (visible only for factura) -->
                <VerticalStackLayout Spacing="5" IsVisible="{Binding InvoiceType, Converter={StaticResource StringEqualConverter}, ConverterParameter='factura'}">
                    <Label Text="RUC" />
                    <Entry Text="{Binding CustomerRuc}" 
                           Placeholder="20123456789"
                           Keyboard="Numeric"
                           MaxLength="11" />
                </VerticalStackLayout>

                <VerticalStackLayout Spacing="5">
                    <Label Text="Dirección (Opcional)" />
                    <Entry Text="{Binding CustomerAddress}" Placeholder="Ingrese dirección" />
                </VerticalStackLayout>
            </VerticalStackLayout>

            <!-- Invoice Preview (if generated) -->
            <Frame IsVisible="{Binding Invoice, Converter={StaticResource NotNullConverter}}"
                   BackgroundColor="#F5F5F5" BorderColor="#E0E0E0" CornerRadius="10" Padding="15">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Vista Previa del Comprobante" FontSize="16" FontAttributes="Bold" />
                    <BoxView HeightRequest="1" BackgroundColor="#E0E0E0" />
                    
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="Tipo:" FontAttributes="Bold" />
                        <Label Text="{Binding Invoice.Type}" />
                    </HorizontalStackLayout>

                    <HorizontalStackLayout Spacing="10">
                        <Label Text="Número:" FontAttributes="Bold" />
                        <Label>
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="{Binding Invoice.SerialNumber}" />
                                    <Span Text="-" />
                                    <Span Text="{Binding Invoice.CorrelativeNumber, StringFormat='{0:D5}'}" />
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>
                    </HorizontalStackLayout>

                    <HorizontalStackLayout Spacing="10">
                        <Label Text="Cliente:" FontAttributes="Bold" />
                        <Label Text="{Binding Invoice.CustomerName}" />
                    </HorizontalStackLayout>

                    <BoxView HeightRequest="1" BackgroundColor="#E0E0E0" />

                    <HorizontalStackLayout Spacing="10">
                        <Label Text="Subtotal:" FontAttributes="Bold" />
                        <Label Text="{Binding Invoice.Subtotal, StringFormat='S/ {0:F2}'}" />
                    </HorizontalStackLayout>

                    <HorizontalStackLayout Spacing="10">
                        <Label Text="IGV (18%):" FontAttributes="Bold" />
                        <Label Text="{Binding Invoice.Igv, StringFormat='S/ {0:F2}'}" />
                    </HorizontalStackLayout>

                    <HorizontalStackLayout Spacing="10">
                        <Label Text="Total:" FontAttributes="Bold" />
                        <Label Text="{Binding Invoice.Total, StringFormat='S/ {0:F2}'}" 
                               FontSize="18" TextColor="#FF6B9D" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Frame>

            <!-- Action Buttons -->
            <Button Text="Generar Comprobante" 
                    Command="{Binding GenerateInvoiceCommand}"
                    BackgroundColor="#FF6B9D"
                    TextColor="White"
                    HeightRequest="50"
                    CornerRadius="10"
                    FontSize="16"
                    FontAttributes="Bold"
                    IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}" />

            <HorizontalStackLayout Spacing="10" 
                                   IsVisible="{Binding Invoice, Converter={StaticResource NotNullConverter}}">
                <Button Text="Descargar PDF" 
                        Command="{Binding DownloadPdfCommand}"
                        BackgroundColor="#2196F3"
                        TextColor="White"
                        HeightRequest="45"
                        CornerRadius="10"
                        HorizontalOptions="FillAndExpand"
                        IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}" />

                <Button Text="Enviar por Email" 
                        Command="{Binding SendEmailCommand}"
                        BackgroundColor="#4CAF50"
                        TextColor="White"
                        HeightRequest="45"
                        CornerRadius="10"
                        HorizontalOptions="FillAndExpand"
                        IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}" />
            </HorizontalStackLayout>

            <!-- Loading Indicator -->
            <ActivityIndicator IsRunning="{Binding IsLoading}" 
                               IsVisible="{Binding IsLoading}"
                               Color="#FF6B9D"
                               HorizontalOptions="Center" />

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
