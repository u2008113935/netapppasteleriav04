<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="apppasteleriav04.Views.Billing.InvoiceListPage"
             xmlns:vm="clr-namespace:apppasteleriav04.ViewModels.Billing"
             Title="Mis Comprobantes">

    <ContentPage.BindingContext>
        <vm:InvoiceListViewModel />
    </ContentPage.BindingContext>

    <Grid RowDefinitions="Auto,*" Padding="0">

        <!-- Filter Section -->
        <Frame Grid.Row="0" BackgroundColor="#F5F5F5" BorderColor="#E0E0E0" 
               CornerRadius="0" Padding="15" Margin="0">
            <VerticalStackLayout Spacing="10">
                <Label Text="Filtros" FontSize="16" FontAttributes="Bold" />
                
                <HorizontalStackLayout Spacing="10">
                    <Picker x:Name="TypePicker" 
                            Title="Tipo" 
                            SelectedIndexChanged="OnFilterChanged"
                            HorizontalOptions="FillAndExpand">
                        <Picker.Items>
                            <x:String>all</x:String>
                            <x:String>boleta</x:String>
                            <x:String>factura</x:String>
                        </Picker.Items>
                    </Picker>

                    <Button Text="ðŸ”„" 
                            Command="{Binding LoadInvoicesCommand}"
                            BackgroundColor="#FF6B9D"
                            TextColor="White"
                            WidthRequest="50"
                            HeightRequest="45"
                            CornerRadius="10" />
                </HorizontalStackLayout>
            </VerticalStackLayout>
        </Frame>

        <!-- Invoices List -->
        <RefreshView Grid.Row="1" 
                     IsRefreshing="{Binding IsBusy}"
                     Command="{Binding LoadInvoicesCommand}">
            <CollectionView ItemsSource="{Binding Invoices}"
                            SelectionMode="None"
                            EmptyView="No hay comprobantes">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="10" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Margin="15,5" Padding="15" BackgroundColor="White" 
                               BorderColor="#E0E0E0" CornerRadius="10">
                            <Frame.GestureRecognizers>
                                <TapGestureRecognizer 
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:InvoiceListViewModel}}, Path=ViewInvoiceCommand}"
                                    CommandParameter="{Binding .}" />
                            </Frame.GestureRecognizers>
                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto,Auto" ColumnSpacing="10" RowSpacing="5">
                                
                                <!-- Invoice Number -->
                                <Label Grid.Row="0" Grid.Column="0" FontAttributes="Bold" FontSize="16">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding SerialNumber}" />
                                            <Span Text="-" />
                                            <Span Text="{Binding CorrelativeNumber, StringFormat='{0:D5}'}" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>

                                <!-- Type Badge -->
                                <Frame Grid.Row="0" Grid.Column="1" 
                                       Padding="8,4" CornerRadius="5"
                                       BackgroundColor="#2196F3"
                                       HasShadow="False">
                                    <Label Text="{Binding Type}" 
                                           TextColor="White" 
                                           FontSize="12"
                                           FontAttributes="Bold" />
                                </Frame>

                                <!-- Customer Name -->
                                <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                       Text="{Binding CustomerName}"
                                       FontSize="14" />

                                <!-- Date -->
                                <Label Grid.Row="2" Grid.Column="0"
                                       Text="{Binding CreatedAt, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                                       FontSize="12" TextColor="#666" />

                                <!-- Total -->
                                <Label Grid.Row="2" Grid.Column="1"
                                       Text="{Binding Total, StringFormat='S/ {0:F2}'}"
                                       FontSize="16" FontAttributes="Bold" TextColor="#FF6B9D" />

                                <!-- SUNAT Status -->
                                <HorizontalStackLayout Grid.Row="3" Grid.Column="0" Spacing="5">
                                    <Label Text="SUNAT:" FontSize="12" TextColor="#666" />
                                    <Label Text="{Binding SunatStatus}" 
                                           FontSize="12"
                                           TextColor="#4CAF50" />
                                </HorizontalStackLayout>

                                <!-- Download Button -->
                                <Button Grid.Row="3" Grid.Column="1"
                                        Text="ðŸ“¥"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:InvoiceListViewModel}}, Path=DownloadCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="#2196F3"
                                        TextColor="White"
                                        WidthRequest="40"
                                        HeightRequest="35"
                                        CornerRadius="5"
                                        Padding="0" />

                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

    </Grid>
</ContentPage>
