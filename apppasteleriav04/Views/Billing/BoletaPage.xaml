<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="apppasteleriav04.Views.Billing.BoletaPage"
             Title="Generar Comprobante">
    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">
            
            <!-- Selector tipo de comprobante -->
            <Label Text="Tipo de Comprobante" FontSize="16" FontAttributes="Bold" />
            <Picker x:Name="InvoiceTypePicker"
                    SelectedItem="{Binding InvoiceType}"
                    Title="Seleccione tipo de comprobante">
                <Picker.ItemsSource>
                    <x:Array Type="{x:Type x:String}">
                        <x:String>boleta</x:String>
                        <x:String>factura</x:String>
                    </x:Array>
                </Picker.ItemsSource>
            </Picker>

            <!-- Campos para factura (solo si es factura) -->
            <VerticalStackLayout IsVisible="{Binding IsFactura}" Spacing="15">
                <Label Text="Datos para Factura" FontSize="16" FontAttributes="Bold" />
                
                <Entry Placeholder="RUC (11 dígitos)" 
                       Text="{Binding CustomerRuc}"
                       Keyboard="Numeric"
                       MaxLength="11" />
                
                <Entry Placeholder="Razón Social" 
                       Text="{Binding CustomerName}"
                       Keyboard="Text" />
            </VerticalStackLayout>

            <!-- Vista previa del comprobante -->
            <Frame BorderColor="#E0E0E0" 
                   CornerRadius="10" 
                   Padding="20"
                   IsVisible="{Binding Invoice, Converter={StaticResource NotNullConverter}}">
                <VerticalStackLayout Spacing="15">
                    <Label Text="Vista Previa del Comprobante" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           HorizontalOptions="Center" />
                    
                    <BoxView HeightRequest="2" Color="#FF6B9D" />
                    
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="{Binding Invoice.Type, StringFormat='Tipo: {0}'}" 
                               FontAttributes="Bold" />
                        <Label Text="{Binding Invoice.SerialNumber, StringFormat='Serie: {0}'}" />
                        <Label Text="{Binding Invoice.CorrelativeNumber, StringFormat='N°: {0}'}" />
                    </HorizontalStackLayout>
                    
                    <Label Text="{Binding Invoice.CustomerName, StringFormat='Cliente: {0}'}" />
                    <Label Text="{Binding Invoice.CustomerRuc, StringFormat='RUC: {0}'}" 
                           IsVisible="{Binding IsFactura}" />
                    
                    <BoxView HeightRequest="1" Color="#E0E0E0" />
                    
                    <HorizontalStackLayout Spacing="10" HorizontalOptions="End">
                        <Label Text="Subtotal:" />
                        <Label Text="{Binding Invoice.Subtotal, StringFormat='S/. {0:N2}'}" 
                               FontAttributes="Bold" />
                    </HorizontalStackLayout>
                    
                    <HorizontalStackLayout Spacing="10" HorizontalOptions="End">
                        <Label Text="IGV (18%):" />
                        <Label Text="{Binding Invoice.Igv, StringFormat='S/. {0:N2}'}" 
                               FontAttributes="Bold" />
                    </HorizontalStackLayout>
                    
                    <HorizontalStackLayout Spacing="10" HorizontalOptions="End">
                        <Label Text="Total:" FontSize="18" FontAttributes="Bold" />
                        <Label Text="{Binding Invoice.Total, StringFormat='S/. {0:N2}'}" 
                               FontSize="18" 
                               FontAttributes="Bold"
                               TextColor="#FF6B9D" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Frame>

            <!-- Indicador de generación -->
            <ActivityIndicator IsRunning="{Binding IsGenerating}" 
                             IsVisible="{Binding IsGenerating}"
                             Color="#FF6B9D"
                             HorizontalOptions="Center" />

            <!-- Mensaje de error -->
            <Label Text="{Binding ErrorMessage}" 
                   TextColor="Red"
                   IsVisible="{Binding HasError}"
                   HorizontalTextAlignment="Center" />

            <!-- Botón generar comprobante -->
            <Button Text="Generar Comprobante" 
                    Command="{Binding GenerateInvoiceCommand}"
                    BackgroundColor="#FF6B9D"
                    TextColor="White"
                    CornerRadius="25"
                    HeightRequest="50"
                    IsEnabled="{Binding IsGenerating, Converter={StaticResource InvertedBoolConverter}}" />

            <!-- Botones de acción (solo visible si ya se generó) -->
            <HorizontalStackLayout Spacing="10" 
                                  IsVisible="{Binding Invoice, Converter={StaticResource NotNullConverter}}">
                <Button Text="Descargar PDF" 
                        Command="{Binding DownloadPdfCommand}"
                        BackgroundColor="#4CAF50"
                        TextColor="White"
                        CornerRadius="25"
                        HorizontalOptions="FillAndExpand" />
                
                <Button Text="Enviar Email" 
                        Command="{Binding SendEmailCommand}"
                        BackgroundColor="#2196F3"
                        TextColor="White"
                        CornerRadius="25"
                        HorizontalOptions="FillAndExpand" />
            </HorizontalStackLayout>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>